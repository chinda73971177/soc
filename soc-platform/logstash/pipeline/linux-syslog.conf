input {
  beats {
    port => 5044
    type => "syslog"
  }
}

filter {
  if [type] == "syslog" {
    grok {
      match => {
        "message" => [
          "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_name} %{PROG:program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:log_message}",
          "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_name} %{GREEDYDATA:log_message}"
        ]
      }
    }
    date {
      match => ["timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss"]
    }
    mutate {
      add_field => { "log_source" => "linux_syslog" }
      add_field => { "log_type" => "system" }
    }
    if [log_message] =~ /fail|error|denied|invalid|refused/i {
      mutate { add_field => { "severity" => "high" } }
    } else if [log_message] =~ /warn|warning/i {
      mutate { add_field => { "severity" => "medium" } }
    } else {
      mutate { add_field => { "severity" => "low" } }
    }
  }
}

output {
  kafka {
    bootstrap_servers => "kafka:9092"
    topic_id => "soc-logs"
    codec => json
  }
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "soc-logs-%{+YYYY.MM.dd}"
  }
}
